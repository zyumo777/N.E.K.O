<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="steam.workshopManager">Steam 创意工坊管理 - Project N.E.K.O.</title>
    <!-- i18next 加载器（统一处理 CDN 加载和初始化） -->
    <script src="/static/i18n-i18next.js"></script>
    <script src="/static/common_dialogs.js"></script>
    <link rel="stylesheet" href="/static/css/steam_workshop_manager.css">
</head>

<body>
    <!-- 页面标题栏 - 支持拖动窗口 -->
    <div class="page-title-bar">
        <h1 data-i18n="steam.workshopManager">Steam 创意工坊管理</h1>
        <button class="close-btn" onclick="window.close(); window.history.back();" title="关闭" style="width: 36px; height: 36px; background: #ff5f57; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; -webkit-app-region: no-drag;">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 4L4 12M4 4L12 12" stroke="white" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
    </div>

    <!-- 侧边栏 -->
    <!-- 布局容器 -->
    <div class="layout-container" style="margin-top: 0; padding-top: 0;">
        <!-- 侧边栏 -->
        <div id="sidebar">
            <!-- 主要操作组 -->
            <div class="menu-section">
                <!-- 标签切换按钮组 -->
                <div class="tabs compact" id="workshop-tabs">
                     <button class="tab active" onclick="switchTab('subscriptions-content', event)" data-i18n="steam.subscriptions">订阅内容</button>
                     <button class="tab" onclick="switchTab('character-cards-content', event)" data-i18n="steam.characterCards">角色卡</button>
                  </div>
                
                <!-- 修复的自定义tooltip实现 -->
                
</div>



<!-- 关于创意工坊集成说明 -->
<div class="menu-section workshop-integration-info">
<div class="info-text">
<p data-i18n="steam.pageDescription">通过此页面，您可以浏览、订阅、下载和管理Steam创意工坊中的Live2D模型和声音。</p>
<p data-i18n="steam.voiceNote">如有语音音色请前往live2d设置页面手动注册</p>
</div>
</div>


</div>

<!-- 主内容区域 -->
<div class="main-content">
<!-- 标题已移除 -->
        
<!-- 标签内容容器 -->
<div class="tab-contents">
<!-- 订阅内容标签页 -->
<div id="subscriptions-content" class="tab-content active">
<div class="section-card">
<div class="section-header">
<h2 data-i18n="steam.mySubscriptions">我的订阅物品</h2>
</div>
                    
<div class="filter-controls">
<div class="filter-group">
<div class="filter-label" data-i18n="steam.search">搜索：</div>
<input type="text" id="search-subscription" class="control-input" placeholder="" onkeyup="filterSubscriptions(this.value)" data-i18n-placeholder="steam.searchPlaceholder">
</div>
<div class="filter-group">
<div class="filter-label" data-i18n="steam.sort.title">排序：</div>
<select id="sort-subscription" class="control-select" onchange="applySort(this.value)">
<option value="name_asc" data-i18n="steam.sort.nameAsc">名称（升序）</option>
<option value="name_desc" data-i18n="steam.sort.nameDesc">名称（降序）</option>
<option value="date_asc" data-i18n="steam.sort.dateAsc">订阅日期（升序）</option>
<option value="date_desc" data-i18n="steam.sort.dateDesc">订阅日期（降序）</option>
<option value="size_asc" data-i18n="steam.sort.sizeAsc">文件大小（升序）</option>
<option value="size_desc" data-i18n="steam.sort.sizeDesc">文件大小（降序）</option>
<option value="update_asc" data-i18n="steam.sort.updateAsc">更新时间（升序）</option>
<option value="update_desc" data-i18n="steam.sort.updateDesc">更新时间（降序）</option>
</select>
</div>
<div class="filter-group">
<button class="btn btn-primary" onclick="loadSubscriptions()" data-i18n="steam.refresh">刷新订阅内容</button>
</div>
</div>
                
<div id="subscriptions-result">
<!-- 卡片容器 -->
<div id="subscriptions-list" class="cards-container">
<!-- 空状态 -->
<div class="empty-state">
<p id="loading-text"></p>
<button class="btn btn-secondary" onclick="loadSubscriptions()" id="reload-button"></button>
</div>
</div>
                    
<div class="pagination">
<button class="btn btn-secondary" onclick="goToPrevPage()" disabled data-i18n="common.prevPage">上一页</button>
<span>第 1 页，共 1 页</span>
<button class="btn btn-secondary" onclick="goToNextPage()" disabled data-i18n="common.nextPage">下一页</button>
</div>
</div>
</div>
</div>
<!-- 本地内容标签页 -->
<div id="local-items-content" class="tab-content" style="display: none;">
                
<div class="section-card">
<div class="section-header">
<h2 data-i18n="steam.localItems">管理本地物品</h2>
</div>
                    
<!-- 搜索和排序功能区域 -->
<div class="filter-controls">
<div class="filter-group">
<div class="filter-label" data-i18n="steam.search">搜索：</div>
<input type="text" id="search-local-items" class="control-input" placeholder="搜索本地物品..." data-i18n-placeholder="steam.searchLocalItems">
</div>
<div class="filter-group">
<div class="filter-label" data-i18n="steam.sort.title">排序：</div>
<select id="sort-local-items" class="control-select">
<option value="name_asc" data-i18n="steam.sort.nameAsc">名称（升序）</option>
<option value="name_desc" data-i18n="steam.sort.nameDesc">名称（降序）</option>
<option value="date_asc" data-i18n="steam.sort.createDateAsc">创建日期（升序）</option>
<option value="date_desc" data-i18n="steam.sort.createDateDesc">创建日期（降序）</option>
</select>
</div>
<div class="filter-group">
<button class="btn btn-primary" onclick="scanLocalItems()" style="min-width: 160px;">
<span data-i18n="steam.scanLocalItems">扫描本地物品</span>
</button>
</div>
</div>
                    
<div id="local-items-list" class="cards-container">
<div class="empty-state">
<p data-i18n="steam.emptyStateHint">请输入并扫描一个包含本地文件的文件夹</p>
</div>
</div>
</div>
</div>
            
<!-- 角色卡标签页 -->
<div id="character-cards-content" class="tab-content" style="display: none;">
<!-- 角色卡列表 -->

<div class="section-card">
<div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
<span data-i18n="steam.characterCardsList" style="white-space: nowrap; margin: 0; line-height: 1; font-size: 16px; font-weight: 500;">角色卡列表</span>
<select id="character-card-select" class="control-input" style="flex: 1; font-size: 14px; padding: 8px 12px; min-width: 0;">
<option value="" disabled selected data-i18n="steam.selectCharacterCard">请选择一个角色卡</option>
</select>
<button class="btn btn-secondary" onclick="window.location.href='/chara_manager'" style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
✏️ <span data-i18n="steam.editInCharaManager">在角色管理中编辑</span>
</button>
</div>
</div>

<!-- 角色卡管理区域 -->
<div class="section-card">
<div class="section-header">
<h2 data-i18n="steam.characterCards">角色卡上传</h2>
</div>

<div class="character-card-layout" id="character-card-layout">
                        
<!-- 上方区域：角色卡信息 + Live2D预览 -->
<div class="character-card-top-row">
<!-- 左上：角色卡信息 -->
<div class="character-card-info-section">
<h3 data-i18n="steam.cardInfoPreview">角色卡信息</h3>
<div id="card-info-preview" style="padding: 12px; border: 1px solid #eaeaea; border-radius: 4px; background-color: #f8f8f8;">
<!-- 角色卡属性将由JavaScript动态生成 -->
<div id="card-info-dynamic-content">
<p style="color: #999; text-align: center;" data-i18n="steam.selectCharacterCard">请选择一个角色卡</p>
</div>
</div>
</div>
                            
<!-- 右上：Live2D预览 -->
<div class="character-card-live2d-section">
<h3 data-i18n="steam.live2dPreview">Live2D</h3>
<div id="live2d-preview-container" style="width: 100%; height: 400px; border: 1px solid #eaeaea; border-radius: 4px; overflow: hidden; background-color: #f8f8f8; display: flex; flex-direction: column; position: relative;">
<!-- Live2D预览内容区域 -->
<div id="live2d-preview-content" style="flex: 1; position: relative; min-height: 0; pointer-events: none;">
<!-- Live2D预览Canvas -->
<canvas id="live2d-preview-canvas" style="display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
<!-- 占位符 -->
<div class="preview-placeholder" style="display: flex; justify-content: center; align-items: center; height: 100%; color: #666; position: relative; z-index: 1;">
<span data-i18n="steam.selectCharaToPreview">请选择角色进行预览</span>
</div>
<!-- 防止点击的覆盖层 -->
<div id="live2d-preview-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: auto;"></div>
<!-- 刷新按钮 -->
<button id="live2d-refresh-btn" style="position: absolute; top: 10px; right: 10px; z-index: 101; width: 30px; height: 30px; border: none; border-radius: 50%; background-color: rgba(0, 0, 0, 0.5); color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 16px; pointer-events: auto;" data-i18n-title="steam.refreshLive2DPreview" title="刷新Live2D预览" onclick="refreshLive2DPreview()">
↻
</button>
</div>
</div>
<div id="live2d-preview-controls" style="padding: 10px; background-color: #f0f0f0; border-top: 1px solid #e0e0e0; margin-top: -1px; border-radius: 0 0 4px 4px;">
<div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
<div style="flex: 1; min-width: 150px;">
<select id="preview-motion-select" class="control-input" style="width: 100%;">
<option value="" data-i18n="steam.selectMotion">选择动作</option>
</select>
</div>
<button id="preview-play-motion-btn" class="btn btn-primary" style="padding: 5px 15px;" disabled>
<span data-i18n="steam.playMotion">播放动作</span>
</button>
</div>
<div style="display: flex; gap: 10px; flex-wrap: wrap;">
<div style="flex: 1; min-width: 150px;">
<select id="preview-expression-select" class="control-input" style="width: 100%;">
<option value="" data-i18n="steam.selectExpression">选择表情</option>
</select>
</div>
<button id="preview-play-expression-btn" class="btn btn-primary" style="padding: 5px 15px;" disabled>
<span data-i18n="steam.playExpression">播放表情</span>
</button>
</div>
</div>
</div>
</div>
                        
<!-- 下方区域：描述 + 标签和按钮 -->
<div class="character-card-bottom-row">
<!-- 左侧：描述区域 -->
<div class="character-card-description-section">
<!-- 版权警告 -->
<div id="copyright-warning" style="display: none; padding: 12px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24; margin-bottom: 15px;">
<strong>⚠️</strong> <span data-i18n="steam.modelCopyrightIssue">您的角色形象存在版权问题，无法上传</span>
</div>
                                
<!-- 可编辑字段：描述 -->
<div class="control-group">
<div class="control-label" data-i18n="steam.characterCardDescription">描述</div>
<textarea id="character-card-description" class="control-input" style="white-space: pre-wrap; min-height: 150px; resize: none; overflow-y: auto;" placeholder="输入角色描述..." data-i18n-placeholder="steam.placeholderCharacterDescription"></textarea>
</div>
                                
<!-- Workshop 状态区域 -->
<div id="workshop-status-area" style="display: none; padding: 12px; background-color: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 4px; margin-top: 15px;">
<div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
<div>
<strong style="color: #0066cc;">✅ <span data-i18n="steam.alreadyUploaded">已上传到创意工坊</span></strong>
<div style="font-size: 12px; color: #666; margin-top: 4px;">
<span data-i18n="steam.uploadTime">上传时间</span>：<span id="workshop-upload-time">-</span>
</div>
<div style="font-size: 12px; color: #666;">
<span data-i18n="steam.workshopItemId">物品ID</span>：<span id="workshop-item-id">-</span>
</div>
</div>
<button class="btn btn-secondary btn-sm" onclick="showWorkshopSnapshot()" style="white-space: nowrap;">
📋 <span data-i18n="steam.viewSnapshot">查看已上传版本</span>
</button>
</div>
</div>
</div>
                            
<!-- 右侧：标签和按钮区域 -->
<div class="character-card-tags-buttons-section">
<!-- 标签区域 -->
<div class="character-card-tags-area">
<div class="control-group" style="margin-bottom: 0;">
<div class="control-label" data-i18n="steam.characterCardTags">角色卡标签</div>
<input type="text" id="character-card-tag-input" class="control-input" placeholder="输入标签，按空格添加" data-i18n-placeholder="steam.tagsPlaceholderSpace">
<div id="character-card-tags-wrapper" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; min-height: 40px; box-sizing: border-box; margin-top: 5px;">
<div class="tags-container" id="character-card-tags-container"></div>
</div>
</div>
</div>
                                
<!-- 无可上传模型时的警告提示 -->
<div id="no-uploadable-models-warning" style="display: none; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; color: #856404; font-size: 14px; margin-top: 15px;">
<span data-i18n="steam.noUploadableModels">没有可上传的模型，请先在角色管理页面创建自定义模型</span>
</div>
                                
<!-- 按钮行：两个按钮并排 -->
<div class="character-card-buttons-row">
<button id="upload-to-workshop-btn" class="btn btn-primary" onclick="handleUploadToWorkshop()" style="padding: 12px 0; font-size: 14px;">
🚀 <span id="upload-btn-text" data-i18n="steam.uploadToWorkshop">上传到创意工坊</span>
</button>
<button class="btn btn-secondary" onclick="window.location.href='/chara_manager'" style="padding: 12px 0; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px;">
✏️ <span data-i18n="steam.editInCharaManager">在角色管理中编辑</span>
</button>
</div>
</div>
</div>
                        
</div>
</div>
                
                

</div>
            
<!-- 上传内容标签页 -->
<div id="upload-content" class="tab-content" style="display: none;">
<!-- 已移除重复的上传页面，统一使用本地物品标签页中的上传功能 -->
</div>
</div>
</div>
</div>

<!-- 物品详情模态框 -->
<div id="itemDetailsModal" class="modal" onclick="closeModalOnOutsideClick(event)">
<div class="modal-content" onclick="event.stopPropagation()">
<div class="modal-header">
<h3 class="modal-title" id="modalTitle" data-i18n="steam.itemDetails">物品详情</h3>
<button class="modal-close" onclick="closeModal()">&times;</button>
</div>
<div class="modal-body">
<div id="itemDetailContent" class="item-detail-container">
<!-- 物品详情内容将通过JavaScript动态加载 -->
<div class="empty-state">
<p data-i18n="steam.loadingItemDetails">正在加载物品详情...</p>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal()" data-i18n="steam.close">关闭</button>
</div>
</div>
</div>

<!-- 上传到创意工坊模态框 -->
<div id="uploadToWorkshopModal" class="modal" onclick="closeUploadModalOnOutsideClick(event)" style="display: none;">
<div class="modal-content" onclick="event.stopPropagation()" style="max-width: 900px;">
<div class="modal-header">
<h3 class="modal-title" data-i18n="steam.uploadToWorkshop">上传到创意工坊</h3>
<button class="modal-close" onclick="closeUploadModal()">&times;</button>
</div>
<div class="modal-body" style="padding: 20px;">
<div id="message-area"></div>
                
<div class="control-group">
<div class="control-label" data-i18n="steam.title">标题</div>
<div id="item-title" class="control-input" style="background-color: #f5f5f5; padding: 8px 12px; border-radius: 4px; min-height: 20px;"></div>
</div>
                
<div class="control-group">
<div class="control-label" data-i18n="steam.description">描述</div>
<div id="item-description" class="control-input" style="background-color: #f5f5f5; padding: 8px 12px; border-radius: 4px; min-height: 60px; white-space: pre-wrap;"></div>
</div>
                
<!-- Content Folder Path 已隐藏，但保留元素供 JS 使用 -->
<input type="hidden" id="content-folder">
                
<div class="control-group">
<div class="control-label" data-i18n="steam.previewImagePath">预览图片路径 *</div>
<div style="display: flex; gap: 8px; align-items: center;">
<input type="text" id="preview-image" class="control-input" placeholder="从本地物品中获取的预览图片路径" data-i18n-placeholder="steam.previewImagePlaceholder">
<input type="file" id="preview-image-file" accept="image/*" style="display: none;">
<button class="btn btn-secondary" onclick="selectPreviewImage()" data-i18n="common.selectFile">选择文件</button>
</div>
<div class="control-hint" id="preview-image-size-hint" style="color: #333; font-size: 14px;" data-i18n="steam.previewImageSizeHint">提示：预览图片大小需要小于1MB</div>
</div>
                
<div class="control-group">
<div class="control-label" data-i18n="steam.tags">标签</div>
<!-- 标签输入框已隐藏，标签通过 tags-container 显示 -->
<input type="hidden" id="item-tags">
<div id="tags-container" class="tags-container"></div>
</div>
                
<div class="control-group">
<div class="control-label" data-i18n="steam.visibility">可见性</div>
<select id="visibility" class="control-select">
<option value="public" data-i18n="steam.visibilityPublic">公开</option>
<option value="friends" data-i18n="steam.visibilityFriends">仅好友可见</option>
<option value="private" data-i18n="steam.visibilityPrivate">私有</option>
</select>
</div>
                
<div class="control-group">
<div class="checkbox-container">
<input type="checkbox" id="allow-comments" class="control-checkbox" checked>
<label for="allow-comments" class="checkbox-label" data-i18n="steam.allowComments">允许评论</label>
</div>
</div>
                
<div class="help-text" style="margin-top: 10px; font-size: 12px; color: #666;" data-i18n="steam.workshopAgreementText">
点击"上传"即表示您同意 Steam 创意工坊服务条款，包括创意工坊法律协议：
<a href="https://steamcommunity.com/sharedfiles/workshoplegalagreement" target="_blank" style="color: #44b7fe;">https://steamcommunity.com/sharedfiles/workshoplegalagreement</a>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-primary" onclick="uploadItem()">
<span data-i18n="steam.uploadToWorkshop">上传到创意工坊</span>
</button>
<button class="btn btn-secondary" onclick="closeUploadModal()" data-i18n="steam.close">关闭</button>
</div>
</div>
</div>

<!-- Workshop 快照查看模态框 -->
<div id="workshopSnapshotModal" class="modal" onclick="closeWorkshopSnapshotModal(event)" style="display: none;">
<div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
<div class="modal-header">
<h3 class="modal-title" data-i18n="steam.uploadedVersionSnapshot">已上传版本快照</h3>
<button class="modal-close" onclick="closeWorkshopSnapshotModal()">&times;</button>
</div>
<div class="modal-body" style="padding: 20px;">
<div class="control-group">
<div class="control-label" data-i18n="steam.snapshotDescription">描述</div>
<div id="snapshot-description" style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; min-height: 60px; white-space: pre-wrap;"></div>
</div>
                
<div class="control-group">
<div class="control-label" data-i18n="steam.snapshotTags">标签</div>
<div id="snapshot-tags-container" style="display: flex; flex-wrap: wrap; gap: 5px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; min-height: 30px;"></div>
</div>
                
<div class="control-group">
<div class="control-label" data-i18n="steam.snapshotModel">使用的模型</div>
<div id="snapshot-model" style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;"></div>
</div>
                
<div id="snapshot-diff-area" style="display: none; margin-top: 15px; padding: 12px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
<strong style="color: #856404;">⚠️ <span data-i18n="steam.diffWithCurrent">与当前版本的差异</span></strong>
<ul id="snapshot-diff-list" style="margin: 10px 0 0 0; padding-left: 20px; color: #856404;"></ul>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeWorkshopSnapshotModal()" data-i18n="steam.close">关闭</button>
</div>
</div>
</div>

<!-- 取消上传确认模态框 -->
<div id="cancelUploadModal" class="modal" onclick="closeCancelUploadModalOnOutsideClick(event)" style="display: none;">
<div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
<div class="modal-header">
<h3 class="modal-title" data-i18n="steam.cancelUpload">取消上传</h3>
<button class="modal-close" onclick="closeCancelUploadModal()">&times;</button>
</div>
<div class="modal-body" style="padding: 20px;">
<p data-i18n="steam.cancelUploadConfirm">确定要取消上传吗？取消后将删除临时文件。</p>
</div>
<div class="modal-footer">
<button class="btn btn-primary" onclick="confirmCancelUpload()" data-i18n="steam.confirmCancel">确定取消</button>
<button class="btn btn-secondary" onclick="closeCancelUploadModal()" data-i18n="steam.continueUpload">继续上传</button>
</div>
</div>
</div>

<!-- 重复上传提示模态框 -->
<div id="duplicateUploadModal" class="modal" onclick="closeDuplicateUploadModalOnOutsideClick(event)" style="display: none;">
<div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
<div class="modal-header">
<h3 class="modal-title" data-i18n="steam.characterCardAlreadyUploaded">角色卡已上传</h3>
<button class="modal-close" onclick="closeDuplicateUploadModal()">&times;</button>
</div>
<div class="modal-body" style="padding: 20px;">
<p id="duplicate-upload-message"></p>
<p style="margin-top: 15px; color: #666; font-size: 14px;" data-i18n="steam.createNewCharacterCardHint">如有需要请创建新的角色卡</p>
</div>
<div class="modal-footer">
<button class="btn btn-primary" onclick="closeDuplicateUploadModal()" data-i18n="common.confirm">确定</button>
</div>
</div>
</div>


    <!-- Live2D SDK 核心库 -->
    <script src="/static/libs/pixi.min.js"></script>
    <script src="/static/libs/live2dcubismcore.min.js"></script>
    <script src="/static/libs/live2d.min.js"></script>
    <script src="/static/libs/index.min.js"></script>
    
    <!-- Live2D功能模块 -->
    <script src="/static/live2d-core.js"></script>
    <script src="/static/live2d-model.js"></script>
    <script src="/static/live2d-interaction.js"></script>
    <script src="/static/live2d-emotion.js"></script>
    <script src="/static/live2d-ui-buttons.js"></script>
    <script src="/static/live2d-init.js"></script>
    
    <script src="/static/js/steam_workshop_manager.js"></script>

    <!-- Driver.js 库 -->
    <script src="/static/libs/driver.min.js"></script>
    <link rel="stylesheet" href="/static/libs/driver.min.css">

    <!-- 通用教程管理器 -->
    <script src="/static/universal-tutorial-manager.js"></script>

    <!-- 初始化 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initUniversalTutorialManager === 'function') {
                initUniversalTutorialManager();
            }
        });
    </script>
</body>

</html>